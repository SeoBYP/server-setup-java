## í”„ë¡œì íŠ¸

## Getting Started

### Prerequisites

#### Running Docker Containers

`local` profile ë¡œ ì‹¤í–‰í•˜ê¸° ìœ„í•˜ì—¬ ì¸í”„ë¼ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ” Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.

```bash
docker-compose up -d
```

# e-ì»¤ë¨¸ìŠ¤ ìƒí’ˆ ì£¼ë¬¸ ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤

## ìš”êµ¬ì‚¬í•­ ë° ìœ ìŠ¤ì¼€ì´ìŠ¤ ì •ì˜
- ìƒí’ˆ ì£¼ë¬¸ì— í•„ìš”í•œ ë©”ë‰´ ì •ë³´ë“¤ì„ êµ¬ì„±í•˜ê³  ì¡°íšŒê°€ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìëŠ” ìƒí’ˆì„ ì—¬ëŸ¬ê°œ ì„ íƒí•´ ì£¼ë¬¸í•  ìˆ˜ ìˆê³ , ë¯¸ë¦¬ ì¶©ì „í•œ ì”ì•¡ì„ ì´ìš©í•©ë‹ˆë‹¤.
- ìƒí’ˆ ì£¼ë¬¸ ë‚´ì—­ì„ í†µí•´ íŒë§¤ëŸ‰ì´ ê°€ì¥ ë†’ì€ ìƒí’ˆì„ ì¶”ì²œí•©ë‹ˆë‹¤.

## ëª©í‘œ
- ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ìƒí’ˆì„ ì„ íƒí•´ ì£¼ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì£¼ë¬¸ ê²°ì œëŠ” **ì¶©ì „ëœ í¬ì¸íŠ¸ ì”ì•¡**ìœ¼ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ìƒí’ˆ ì¬ê³ ì™€ ì‚¬ìš©ì ì”ì•¡ì€ **ë™ì‹œì„± ìƒí™©ì—ì„œë„ ì •í•©ì„±**ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
- ì£¼ë¬¸ ì„±ê³µ ì‹œ, **ë°ì´í„° í”Œë«í¼(ì™¸ë¶€ ì„œë¹„ìŠ¤)** ìœ¼ë¡œ ì£¼ë¬¸ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.
- ì„ ì°©ìˆœ ì¿ í° ë° ì¸ê¸° ìƒí’ˆ ì¶”ì²œ ê¸°ëŠ¥ì„ í†µí•´ ë¶€ê°€ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ§© ê¸°ëŠ¥ ëª©ë¡ (Requirements)

### âœ… í•„ìˆ˜ ê¸°ëŠ¥

| êµ¬ë¶„ | ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|------|
| 1 | **ìƒí’ˆ ì¡°íšŒ API** | ìƒí’ˆ ëª©ë¡(ID, ì´ë¦„, ê°€ê²©, ì”ì—¬ìˆ˜ëŸ‰) ì¡°íšŒ |
| 2 | **ì£¼ë¬¸ / ê²°ì œ API** | ì‚¬ìš©ì IDì™€ (ìƒí’ˆID, ìˆ˜ëŸ‰) ëª©ë¡ ì…ë ¥ â†’ ì£¼ë¬¸ ë° ê²°ì œ ì²˜ë¦¬ |
| 3 | **í¬ì¸íŠ¸ ì¶©ì „ / ì¡°íšŒ API** | ì‚¬ìš©ìì˜ í¬ì¸íŠ¸ ì¶©ì „ ë° ì”ì•¡ ì¡°íšŒ |
| 4 | **ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ ì—°ë™(Mock)** | ì£¼ë¬¸ ì™„ë£Œ ì‹œ, ì™¸ë¶€ APIë¡œ ì£¼ë¬¸ ë°ì´í„° ì „ì†¡ |
| 5 | **ì¬ê³  / ì”ì•¡ ë™ì‹œì„± ì œì–´** | ë‹¤ì¤‘ íŠ¸ëœì­ì…˜ í™˜ê²½ì—ì„œë„ ì •í•©ì„± ìœ ì§€ (ë½/íŠ¸ëœì­ì…˜) |

### âš™ï¸ ì„ íƒ ê¸°ëŠ¥

| êµ¬ë¶„ | ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|------|
| 6 | **ì„ ì°©ìˆœ ì¿ í° ê¸°ëŠ¥** | ì¿ í° ë°œê¸‰ ë° ì‚¬ìš© / ìœ íš¨ì„± ê²€ì¦ / í• ì¸ ì ìš© |
| 7 | **ì¸ê¸° ìƒí’ˆ ì¡°íšŒ API** | ìµœê·¼ 3ì¼ê°„ íŒë§¤ëŸ‰ ê¸°ì¤€ ìƒìœ„ 5ê°œ ìƒí’ˆ ì¡°íšŒ |

---

## ğŸ§  ë¹„ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­ (Non-functional Requirements)

| í•­ëª© | ë‚´ìš© |
|------|------|
| ì„±ëŠ¥ | 1ì´ˆ ë‚´ API ì‘ë‹µ, ë™ì‹œ ì£¼ë¬¸ 100ê±´ ì´ìƒ ì²˜ë¦¬ ê°€ëŠ¥ |
| ë°ì´í„° ì¼ê´€ì„± | ì£¼ë¬¸/ê²°ì œ/ì¬ê³ /í¬ì¸íŠ¸ëŠ” íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ì›ìì  ì²˜ë¦¬ |
| í™•ì¥ì„± | ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œë„ ì¿ í°/ì¬ê³  ì •í•©ì„± ìœ ì§€ |
| í…ŒìŠ¤íŠ¸ | ëª¨ë“  ê¸°ëŠ¥ë³„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸ (Testcontainers ê¸°ë°˜) |
| ê°€ìš©ì„± | Docker Composeë¡œ ë¡œì»¬ í†µí•© ì‹¤í–‰ ê°€ëŠ¥ (MySQL + Redis í¬í•¨) |
| ë³´ì•ˆ | ì¸ì¦/ì¸ê°€ Mock ì²˜ë¦¬ (ìœ ì €ID ê¸°ë°˜) |

---

## ğŸ“‹ ìœ ìŠ¤ì¼€ì´ìŠ¤ (Use Cases)

### 1ï¸âƒ£ ìƒí’ˆ ì¡°íšŒ

**Actor**: ì‚¬ìš©ì  
**Flow**:
1. ì‚¬ìš©ìê°€ ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ ì ‘ì†
2. ì„œë²„ëŠ” ìƒí’ˆ ì •ë³´(ID, ì´ë¦„, ê°€ê²©, ì”ì—¬ìˆ˜ëŸ‰)ë¥¼ ë°˜í™˜
3. ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ì¬ê³  ìƒíƒœë¥¼ í‘œì‹œ

**ì˜ˆì™¸**: ìƒí’ˆ ë°ì´í„° ë¶ˆì¼ì¹˜ ì‹œ ìµœì‹  ì¬ê³  ê¸°ì¤€ìœ¼ë¡œ ë°˜í™˜

---

### 2ï¸âƒ£ ì£¼ë¬¸ ë° ê²°ì œ

**Actor**: ì‚¬ìš©ì  
**Flow**:
1. ì‚¬ìš©ìê°€ ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆ ëª©ë¡ê³¼ ìˆ˜ëŸ‰ ì„ íƒ
2. ì„œë²„ëŠ” í•´ë‹¹ ìƒí’ˆ ì¬ê³ ì™€ ì‚¬ìš©ì ì”ì•¡ì„ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ í™•ì¸
3. ì¬ê³  ë° ì”ì•¡ì´ ì¶©ë¶„í•˜ë©´ ê²°ì œ â†’ ì”ì•¡ ì°¨ê°, ì¬ê³  ê°ì†Œ
4. ì£¼ë¬¸/ê²°ì œ ì„±ê³µ ì‹œ, **ì£¼ë¬¸ ì´ë²¤íŠ¸ë¥¼ Outbox í…Œì´ë¸”ì— ê¸°ë¡**
5. Outbox ì›Œì»¤ê°€ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼(Mock API)ìœ¼ë¡œ ì „ì†¡

**ì˜ˆì™¸ í”Œë¡œìš°**:
- [E-01] ì¬ê³  ë¶€ì¡± â†’ ì£¼ë¬¸ ì‹¤íŒ¨
- [E-02] ì”ì•¡ ë¶€ì¡± â†’ ê²°ì œ ì‹¤íŒ¨
- [E-03] ì™¸ë¶€ ì „ì†¡ ì‹¤íŒ¨ â†’ Outbox ìƒíƒœ `FAILED` ë¡œ ë‚¨ê¸°ê³  ì¬ì‹œë„

---

### 3ï¸âƒ£ í¬ì¸íŠ¸ ì¶©ì „ / ì¡°íšŒ

**Actor**: ì‚¬ìš©ì  
**Flow**:
1. ì‚¬ìš©ìê°€ ì¶©ì „ ê¸ˆì•¡ ì…ë ¥
2. ì„œë²„ëŠ” í•´ë‹¹ ìœ ì €ì˜ `wallet` í–‰ì„ ì ê·¸ê³  ê¸ˆì•¡ì„ ì¦ê°€
3. ì„±ê³µ ì‹œ ìµœì‹  ì”ì•¡ ë°˜í™˜

**ì˜ˆì™¸**:
- DB íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ ì‹œ ì¶©ì „ ë°˜ì˜ ì•ˆ ë¨
- ì˜ëª»ëœ ìœ ì €ID ì…ë ¥ ì‹œ 404 ë°˜í™˜

---

### 4ï¸âƒ£ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ / ì‚¬ìš©

**Actor**: ì‚¬ìš©ì  
**Flow**:
1. ì‚¬ìš©ìê°€ íŠ¹ì • ì¿ í° ì½”ë“œë¡œ ì¿ í° ë°œê¸‰ ìš”ì²­
2. Redis `DECR`ë¡œ ì”ì—¬ ìˆ˜ëŸ‰ ì›ì ê°ì†Œ
3. ì„±ê³µ ì‹œ DBì— `user_coupons` INSERT
4. ì£¼ë¬¸ ì‹œ ì¿ í°ì½”ë“œë¥¼ í•¨ê»˜ ì œì¶œí•˜ë©´ í• ì¸ ì ìš©
5. ì‚¬ìš©ëœ ì¿ í°ì€ ìƒíƒœ `USED`ë¡œ ë³€ê²½

**ì˜ˆì™¸**:
- [C-01] ì¿ í° ìˆ˜ëŸ‰ ì†Œì§„ â†’ ë°œê¸‰ ì‹¤íŒ¨
- [C-02] ì´ë¯¸ ë°œê¸‰ë°›ì€ ì‚¬ìš©ì â†’ ì¤‘ë³µ ë°œê¸‰ ë°©ì§€

---

### 5ï¸âƒ£ ì¸ê¸° ìƒí’ˆ ì¡°íšŒ

**Actor**: ì‚¬ìš©ì / ê´€ë¦¬ì  
**Flow**:
1. ìµœê·¼ 3ì¼ê°„ `order_items` ê¸°ì¤€ìœ¼ë¡œ íŒë§¤ëŸ‰ í•©ì‚°
2. íŒë§¤ëŸ‰ ìƒìœ„ 5ê°œ ìƒí’ˆ ë°˜í™˜
3. Redisì— ìºì‹± (1ë¶„ TTL)

---

## âš¡ ì‹œìŠ¤í…œ ë™ì‘ ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½

```mermaid
sequenceDiagram
    participant User
    participant API
    participant DB
    participant Redis
    participant DataPlatform

    User->>API: ì£¼ë¬¸ ìš”ì²­ (ìƒí’ˆ ëª©ë¡, ìˆ˜ëŸ‰)
    API->>DB: íŠ¸ëœì­ì…˜ ì‹œì‘ (wallet, product í–‰ ì ê¸ˆ)
    DB-->>API: ì¬ê³ /ì”ì•¡ í™•ì¸ OK
    API->>DB: ì¬ê³  ê°ì†Œ, ì”ì•¡ ì°¨ê°, ì£¼ë¬¸ ì €ì¥
    API->>DB: Outbox ì´ë²¤íŠ¸ ê¸°ë¡
    DB-->>API: Commit
    API->>DataPlatform: ì£¼ë¬¸ ì´ë²¤íŠ¸ ì „ì†¡(Mock)
    API-->>User: ì£¼ë¬¸ ì™„ë£Œ ì‘ë‹µ
```

# ğŸ—„ï¸ ERD ì„¤ê³„

## ğŸ“Œ ê°œìš”
ë³¸ í”„ë¡œì íŠ¸ëŠ” e-ì»¤ë¨¸ìŠ¤ ì£¼ë¬¸ ì„œë¹„ìŠ¤ì˜ **ì •í•©ì„±, ë™ì‹œì„±, ë©±ë“±ì„±**ì„ ëª¨ë‘ ê³ ë ¤í•œ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.  
ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œë„ ì¬ê³ /í¬ì¸íŠ¸/ì¿ í°ì˜ ë¬´ê²°ì„±ì„ ìœ ì§€í•˜ë©°, Outbox íŒ¨í„´ì„ í†µí•´ ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ê³¼ì˜ **ë°ì´í„° ì¼ê´€ì„±**ì„ ë³´ì¥í•©ë‹ˆë‹¤.

> ğŸ”— ERD Cloud Diagram: [ERD Cloud ë°”ë¡œê°€ê¸°](https://www.erdcloud.com/p/BNbziboLiCBswccSH)

![ERD Diagram](docs/assets/erd_diagram.png)

---

### ğŸ§± í…Œì´ë¸” êµ¬ì¡° ìš”ì•½

| í…Œì´ë¸”ëª… | ì£¼ìš” ì»¬ëŸ¼ ìš”ì•½ | í•µì‹¬ ì œì•½ / ì¸ë±ìŠ¤ | ì„¤ëª… |
|-----------|----------------|--------------------|------|
| **users** | `user_id`, `name`, `created_at` | PK(`user_id`) | ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ |
| **wallets** | `user_id`, `balance` | PK(`user_id`), FKâ†’`users`, `CHECK(balance â‰¥ 0)` | ì‚¬ìš©ì í¬ì¸íŠ¸ ì”ì•¡ ê´€ë¦¬ |
| **orders** | `order_id`, `user_id`, `status`, `total_amount`, `discount_amount`, `paid_amount`, `idempotency_key`, `user_coupon_id`, `created_at` | `UNIQUE(idempotency_key)`<br>`FK(user_coupon_id â†’ user_coupons.id)`<br>`INDEX(status, created_at)`<br>`INDEX(user_id, created_at)` | ì£¼ë¬¸ / ê²°ì œ ë‹¨ìœ„ ë°ì´í„°. ë©±ë“±í‚¤ë¡œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€ |
| **order_items** | `order_item_id`, `order_id`, `product_id`, `unit_price`, `quantity`, `subtotal` | `UNIQUE(order_id, product_id)`<br>`CHECK(quantity > 0)`<br>`CHECK(unit_price â‰¥ 0)`<br>`CHECK(subtotal â‰¥ 0)` | ì£¼ë¬¸ ìƒì„¸ í’ˆëª©. ê°™ì€ ìƒí’ˆ ì¤‘ë³µ ì‚½ì… ë°©ì§€ |
| **payments** | `payment_id`, `order_id`, `amount`, `status`, `paid_at` | `UNIQUE(order_id)`<br>`ENUM('SUCCESS','FAILED')` | ì£¼ë¬¸ 1ê±´ë‹¹ ê²°ì œ 1íšŒ ë³´ì¥ |
| **products** | `id`, `name`, `price`, `stock`, `created_at` | PK(`id`), `CHECK(stock â‰¥ 0)` | ìƒí’ˆ ê¸°ë³¸ ì •ë³´ / ì¬ê³  ê´€ë¦¬ |
| **coupons** | `coupon_id`, `code`, `type`, `value`, `starts_at`, `ends_at`, `created_at` | `UNIQUE(code)`<br>`ENUM('PERCENT','FIXED')` | ì¿ í° ì •ì˜ í…Œì´ë¸” (ì„ ì°©ìˆœ ë°œê¸‰ ê¸°ì¤€) |
| **user_coupons** | `id`, `user_id`, `coupon_id`, `status`, `claimed_at`, `used_at` | `UNIQUE(user_id, coupon_id)`<br>`INDEX(user_id, status)` | ì‚¬ìš©ìë³„ ì¿ í° ë³´ìœ /ì‚¬ìš© ë‚´ì—­ |
| **point_ledger** | `id`, `user_id`, `order_id`, `delta`, `reason`, `created_at` | PK(`id`), `ENUM('CHARGE','ORDER')` | í¬ì¸íŠ¸ ì¦ê° ë¡œê·¸. ê²°ì œ ì‹œ ì°¨ê°, ì¶©ì „ ì‹œ ì¦ê°€ ê¸°ë¡ |
| **outbox** | `id`, `aggregate_type`, `aggregate_id`, `payload`, `status`, `created_at` | `INDEX(status, id)`<br>`ENUM('PENDING','SENT','FAILED')` | ì™¸ë¶€ ë°ì´í„° í”Œë«í¼ ì „ì†¡ ë³´ì¥ìš© ì´ë²¤íŠ¸ ë¡œê·¸ |

---

### ğŸ’¡ ì„¤ê³„ í¬ì¸íŠ¸

| êµ¬ë¶„ | ì„¤ëª… |
|------|------|
| **ì •í•©ì„± ë³´ì¥** | `FOR UPDATE` íŠ¸ëœì­ì…˜ìœ¼ë¡œ Wallet / Product ì¬ê³ ë¥¼ ì•ˆì „í•˜ê²Œ ì ê¸ˆ |
| **ë©±ë“±ì„± (Idempotency)** | `orders.idempotency_key UNIQUE` ë¡œ ì¤‘ë³µ ì£¼ë¬¸ ìƒì„± ë°©ì§€ |
| **ë°ì´í„° ì¶”ì ì„±** | Coupon â†’ UserCoupon â†’ Order íë¦„ìœ¼ë¡œ ì¿ í° ì‚¬ìš© ë‚´ì—­ ì¶”ì  ê°€ëŠ¥ |
| **ë¬´ê²°ì„± ì œì•½** | CHECK, UNIQUE, FKë¡œ ìŒìˆ˜/ì¤‘ë³µ/ê³ ì•„ ë°ì´í„° ë°©ì§€ |
| **Outbox íŒ¨í„´** | ì£¼ë¬¸ ì»¤ë°‹ê³¼ ì™¸ë¶€ ì „ì†¡(ë°ì´í„° í”Œë«í¼ ì—°ë™)ì„ ì›ìì ìœ¼ë¡œ ë¶„ë¦¬ |
| **ì¡°íšŒ ì„±ëŠ¥** | `status`, `user_id`, `created_at` ê¸°ë°˜ ì¸ë±ìŠ¤ë¡œ í†µê³„/ì´ë ¥ ì¡°íšŒ ìµœì í™” |

---

### ğŸ§© ERD íŠ¹ì§• ìš”ì•½

- **íŠ¸ëœì­ì…˜ ì¤‘ì‹¬ ì²˜ë¦¬:** Wallet + Product + Orderë¥¼ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì–´ ë™ì‹œì„± ë¬¸ì œ ë°©ì§€
- **ì¬ê³  ë° í¬ì¸íŠ¸ ì •í•©ì„±:** DB ë‹¨ì—ì„œë§Œ ê´€ë¦¬í•˜ë©° ë¹„ì¦ˆë‹ˆìŠ¤ ë ˆë²¨ Lock ë¶ˆí•„ìš”
- **Outbox ê¸°ë°˜ í™•ì¥ì„±:** ë°ì´í„° ë¶„ì„ í”Œë«í¼ ë“± ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ê³„ì— ì•ˆì „
- **ì •ê·œí™” ì™„ë£Œ:** ë°ì´í„° ì¤‘ë³µ ìµœì†Œí™”, ì¸ë±ìŠ¤ íš¨ìœ¨ ê·¹ëŒ€í™”
- **í™•ì¥ ê°€ëŠ¥:** ì£¼ë¬¸, ì¿ í°, í¬ì¸íŠ¸ ê¸°ëŠ¥ì„ ë…ë¦½ì ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥

---
